import numpy as np
import argparse
import os
import h5py
import pyarrow as pa
import pyarrow.parquet as pq
import glob
from tqdm.contrib.concurrent import process_map
from functools import partial

DTYPES=dict(
    SOURCE=dict(
        ag_gspphot                        ="float32",
        ag_gspphot_lower                  ="float32",
        ag_gspphot_upper                  ="float32",
        astrometric_chi2_al               ="float32",
        astrometric_excess_noise          ="float32",
        astrometric_excess_noise_sig      ="float32",
        astrometric_gof_al                ="float32",
        astrometric_matched_transits      ="int16",
        astrometric_n_bad_obs_al          ="int16",
        astrometric_n_good_obs_al         ="int16",
        astrometric_n_obs_ac              ="int16",
        astrometric_n_obs_al              ="int16",
        astrometric_params_solved         ="int8",
        astrometric_primary_flag          ="int32",
        astrometric_sigma5d_max           ="float32",
        azero_gspphot                     ="float32",
        azero_gspphot_lower               ="float32",
        azero_gspphot_upper               ="float32",
        b                                 ="float64",
        bp_g                              ="float32",
        bp_rp                             ="float32",
        classprob_dsc_combmod_galaxy      ="float32",
        classprob_dsc_combmod_quasar      ="float32",
        classprob_dsc_combmod_star        ="float32",
        dec                               ="float64",
        dec_error                         ="float32",
        dec_parallax_corr                 ="float32",
        dec_pmdec_corr                    ="float32",
        dec_pmra_corr                     ="float32",
        dec_pseudocolour_corr             ="float32",
        distance_gspphot                  ="float32",
        distance_gspphot_lower            ="float32",
        distance_gspphot_upper            ="float32",
        duplicated_source                 ="int32",
        ebpminrp_gspphot                  ="float32",
        ebpminrp_gspphot_lower            ="float32",
        ebpminrp_gspphot_upper            ="float32",
        ecl_lat                           ="float64",
        ecl_lon                           ="float64",
        g_rp                              ="float32",
        grvs_mag                          ="float32",
        grvs_mag_error                    ="float32",
        grvs_mag_nb_transits              ="int16",
        has_epoch_photometry              ="int32",
        has_epoch_rv                      ="int32",
        has_mcmc_gspphot                  ="int32",
        has_mcmc_msc                      ="int32",
        has_rvs                           ="int32",
        has_xp_continuous                 ="int32",
        has_xp_sampled                    ="int32",
        in_andromeda_survey               ="int32",
        in_galaxy_candidates              ="int32",
        in_qso_candidates                 ="int32",
        ipd_frac_multi_peak               ="int8",
        ipd_frac_odd_win                  ="int8",
        ipd_gof_harmonic_amplitude        ="float32",
        ipd_gof_harmonic_phase            ="float32",
        l                                 ="float64",
        libname_gspphot                   ="int8",
        logg_gspphot                      ="float32",
        logg_gspphot_lower                ="float32",
        logg_gspphot_upper                ="float32",
        matched_transits                  ="int16",
        matched_transits_removed          ="int16",
        mh_gspphot                        ="float32",
        mh_gspphot_lower                  ="float32",
        mh_gspphot_upper                  ="float32",
        new_matched_transits              ="int16",
        non_single_star                   ="int16",
        nu_eff_used_in_astrometry         ="float32",
        parallax                          ="float64",
        parallax_error                    ="float32",
        parallax_over_error               ="float32",
        parallax_pmdec_corr               ="float32",
        parallax_pmra_corr                ="float32",
        parallax_pseudocolour_corr        ="float32",
        phot_bp_mean_flux                 ="float64",
        phot_bp_mean_flux_error           ="float32",
        phot_bp_mean_flux_over_error      ="float32",
        phot_bp_mean_mag                  ="float32",
        phot_bp_n_blended_transits        ="int16",
        phot_bp_n_contaminated_transits   ="int16",
        phot_bp_n_obs                     ="int16",
        phot_bp_rp_excess_factor          ="float32",
        phot_g_mean_flux                  ="float64",
        phot_g_mean_flux_error            ="float32",
        phot_g_mean_flux_over_error       ="float32",
        phot_g_mean_mag                   ="float32",
        phot_g_n_obs                      ="int16",
        phot_proc_mode                    ="int8",
        phot_rp_mean_flux                 ="float64",
        phot_rp_mean_flux_error           ="float32",
        phot_rp_mean_flux_over_error      ="float32",
        phot_rp_mean_mag                  ="float32",
        phot_rp_n_blended_transits        ="int16",
        phot_rp_n_contaminated_transits   ="int16",
        phot_rp_n_obs                     ="int16",
        phot_variable_flag                ="int8",
        pm                                ="float32",
        pmdec                             ="float64",
        pmdec_error                       ="float32",
        pmdec_pseudocolour_corr           ="float32",
        pmra                              ="float64",
        pmra_error                        ="float32",
        pmra_pmdec_corr                   ="float32",
        pmra_pseudocolour_corr            ="float32",
        pseudocolour                      ="float32",
        pseudocolour_error                ="float32",
        ra                                ="float64",
        ra_dec_corr                       ="float32",
        ra_error                          ="float32",
        ra_parallax_corr                  ="float32",
        ra_pmdec_corr                     ="float32",
        ra_pmra_corr                      ="float32",
        ra_pseudocolour_corr              ="float32",
        radial_velocity                   ="float32",
        radial_velocity_error             ="float32",
        random_index                      ="int64",
        ref_epoch                         ="float64",
        ruwe                              ="float32",
        rv_amplitude_robust               ="float32",
        rv_atm_param_origin               ="int16",
        rv_chisq_pvalue                   ="float32",
        rv_expected_sig_to_noise          ="float32",
        rv_method_used                    ="int8",
        rv_nb_deblended_transits          ="int16",
        rv_nb_transits                    ="int16",
        rv_renormalised_gof               ="float32",
        rv_template_fe_h                  ="float32",
        rv_template_logg                  ="float32",
        rv_template_teff                  ="float32",
        rv_time_duration                  ="float32",
        rv_visibility_periods_used        ="int16",
        rvs_spec_sig_to_noise             ="float32",
        scan_direction_mean_k1            ="float32",
        scan_direction_mean_k2            ="float32",
        scan_direction_mean_k3            ="float32",
        scan_direction_mean_k4            ="float32",
        scan_direction_strength_k1        ="float32",
        scan_direction_strength_k2        ="float32",
        scan_direction_strength_k3        ="float32",
        scan_direction_strength_k4        ="float32",
        solution_id                       ="int64",
        source_id                         ="int64",
        teff_gspphot                      ="float32",
        teff_gspphot_lower                ="float32",
        teff_gspphot_upper                ="float32",
        vbroad                            ="float32",
        vbroad_error                      ="float32",
        vbroad_nb_transits                ="int16",
        visibility_periods_used           ="int16",
    ),
    XP = dict(
        bp_basis_function_id         = "int16",
        bp_chi_squared               = "float32",
        bp_coefficient_correlations  = "<f4",
        bp_coefficient_errors        = "<f4",
        bp_coefficients              = "<f8",
        bp_degrees_of_freedom        = "int16",
        bp_n_measurements            = "int16",
        bp_n_parameters              = "int8",
        bp_n_rejected_measurements   = "int16",
        bp_n_relevant_bases          = "int16",
        bp_relative_shrinking        = "float32",
        bp_standard_deviation        = "float32",
        dec                          = "float64",
        ra                           = "float64",
        rp_basis_function_id         = "int16",
        rp_chi_squared               = "float32",
        rp_coefficient_correlations  = "<f4",
        rp_coefficient_errors        = "<f4",
        rp_coefficients              = "<f8",
        rp_degrees_of_freedom        = "int16",
        rp_n_measurements            = "int16",
        rp_n_parameters              = "int8",
        rp_n_rejected_measurements   = "int16",
        rp_n_relevant_bases          = "int16",
        rp_relative_shrinking        = "float32",
        rp_standard_deviation        = "float32",
        solution_id                  = "int64",
        source_id                    = "int64",
    ),
    RVS = dict(
        combined_ccds     = "int16",
        combined_transits = "int16",
        deblended_ccds    = "int16",
        dec               = "float64",
        flux              = "<f4",
        flux_error        = "<f4",
        ra                = "float64",
        solution_id       = "int64",
        source_id         = "int64",
    ),
    AP = dict(
        abp_gspphot                        =   "float32",
        abp_gspphot_lower                  =   "float32",
        abp_gspphot_upper                  =   "float32",
        activityindex_espcs                =   "float32",
        activityindex_espcs_input          =   "int8",
        activityindex_espcs_uncertainty    =   "float32",
        ag_esphs                           =   "float32",
        ag_esphs_uncertainty               =   "float32",
        ag_gspphot                         =   "float32",
        ag_gspphot_lower                   =   "float32",
        ag_gspphot_upper                   =   "float32",
        ag_msc                             =   "float32",
        ag_msc_lower                       =   "float32",
        ag_msc_upper                       =   "float32",
        age_flame                          =   "float32",
        age_flame_lower                    =   "float32",
        age_flame_upper                    =   "float32",
        alphafe_gspspec                    =   "float32",
        alphafe_gspspec_lower              =   "float32",
        alphafe_gspspec_upper              =   "float32",
        arp_gspphot                        =   "float32",
        arp_gspphot_lower                  =   "float32",
        arp_gspphot_upper                  =   "float32",
        azero_esphs                        =   "float32",
        azero_esphs_uncertainty            =   "float32",
        azero_gspphot                      =   "float32",
        azero_gspphot_lower                =   "float32",
        azero_gspphot_upper                =   "float32",
        azero_msc                          =   "float32",
        azero_msc_lower                    =   "float32",
        azero_msc_upper                    =   "float32",
        bc_flame                           =   "float32",
        cafe_gspspec                       =   "float32",
        cafe_gspspec_linescatter           =   "float32",
        cafe_gspspec_lower                 =   "float32",
        cafe_gspspec_nlines                =   "int32",
        cafe_gspspec_upper                 =   "float32",
        cefe_gspspec                       =   "float32",
        cefe_gspspec_linescatter           =   "float32",
        cefe_gspspec_lower                 =   "float32",
        cefe_gspspec_nlines                =   "int32",
        cefe_gspspec_upper                 =   "float32",
        classlabel_espels                  =   "int8",
        classlabel_espels_flag             =   "int8",
        classprob_dsc_allosmod_galaxy      =   "float32",
        classprob_dsc_allosmod_quasar      =   "float32",
        classprob_dsc_allosmod_star        =   "float32",
        classprob_dsc_combmod_binarystar   =   "float32",
        classprob_dsc_combmod_galaxy       =   "float32",
        classprob_dsc_combmod_quasar       =   "float32",
        classprob_dsc_combmod_star         =   "float32",
        classprob_dsc_combmod_whitedwarf   =   "float32",
        classprob_dsc_specmod_binarystar   =   "float32",
        classprob_dsc_specmod_galaxy       =   "float32",
        classprob_dsc_specmod_quasar       =   "float32",
        classprob_dsc_specmod_star         =   "float32",
        classprob_dsc_specmod_whitedwarf   =   "float32",
        classprob_espels_bestar            =   "float32",
        classprob_espels_dmestar           =   "float32",
        classprob_espels_herbigstar        =   "float32",
        classprob_espels_pne               =   "float32",
        classprob_espels_ttauristar        =   "float32",
        classprob_espels_wcstar            =   "float32",
        classprob_espels_wnstar            =   "float32",
        cn0_gspspec_centralline            =   "float32",
        cn0_gspspec_width                  =   "float32",
        cn0ew_gspspec                      =   "float32",
        cn0ew_gspspec_uncertainty          =   "float32",
        crfe_gspspec                       =   "float32",
        crfe_gspspec_linescatter           =   "float32",
        crfe_gspspec_lower                 =   "float32",
        crfe_gspspec_nlines                =   "int32",
        crfe_gspspec_upper                 =   "float32",
        dec                                =   "float64",
        dib_gspspec_lambda                 =   "float32",
        dib_gspspec_lambda_uncertainty     =   "float32",
        dibew_gspspec                      =   "float32",
        dibew_gspspec_uncertainty          =   "float32",
        dibewnoise_gspspec_uncertainty     =   "float32",
        dibp0_gspspec                      =   "float32",
        dibp2_gspspec                      =   "float32",
        dibp2_gspspec_uncertainty          =   "float32",
        dibqf_gspspec                      =   "int32",
        distance_gspphot                   =   "float32",
        distance_gspphot_lower             =   "float32",
        distance_gspphot_upper             =   "float32",
        distance_msc                       =   "float32",
        distance_msc_lower                 =   "float32",
        distance_msc_upper                 =   "float32",
        ebpminrp_esphs                     =   "float32",
        ebpminrp_esphs_uncertainty         =   "float32",
        ebpminrp_gspphot                   =   "float32",
        ebpminrp_gspphot_lower             =   "float32",
        ebpminrp_gspphot_upper             =   "float32",
        evolstage_flame                    =   "int32",
        ew_espels_halpha                   =   "float32",
        ew_espels_halpha_flag              =   "int32",
        ew_espels_halpha_model             =   "float32",
        ew_espels_halpha_uncertainty       =   "float32",
        feiim_gspspec                      =   "float32",
        feiim_gspspec_linescatter          =   "float32",
        feiim_gspspec_lower                =   "float32",
        feiim_gspspec_nlines               =   "int32",
        feiim_gspspec_upper                =   "float32",
        fem_gspspec                        =   "float32",
        fem_gspspec_linescatter            =   "float32",
        fem_gspspec_lower                  =   "float32",
        fem_gspspec_nlines                 =   "int32",
        fem_gspspec_upper                  =   "float32",
        flags_esphs                        =   "int16",
        flags_espucd                       =   "int8",
        flags_flame                        =   "int8",
        flags_gspspec                      =   "|S41",
        flags_msc                          =   "int32",
        flags_oa                           =   "int16",
        gravredshift_flame                 =   "float32",
        gravredshift_flame_lower           =   "float32",
        gravredshift_flame_upper           =   "float32",
        libname_gspphot                    =   "int8",
        logchisq_gspspec                   =   "float32",
        logg_esphs                         =   "float32",
        logg_esphs_uncertainty             =   "float32",
        logg_gspphot                       =   "float32",
        logg_gspphot_lower                 =   "float32",
        logg_gspphot_upper                 =   "float32",
        logg_gspspec                       =   "float32",
        logg_gspspec_lower                 =   "float32",
        logg_gspspec_upper                 =   "float32",
        logg_msc1                          =   "float32",
        logg_msc1_lower                    =   "float32",
        logg_msc1_upper                    =   "float32",
        logg_msc2                          =   "float32",
        logg_msc2_lower                    =   "float32",
        logg_msc2_upper                    =   "float32",
        logposterior_gspphot               =   "float32",
        logposterior_msc                   =   "float32",
        lum_flame                          =   "float32",
        lum_flame_lower                    =   "float32",
        lum_flame_upper                    =   "float32",
        mass_flame                         =   "float32",
        mass_flame_lower                   =   "float32",
        mass_flame_upper                   =   "float32",
        mcmcaccept_gspphot                 =   "float32",
        mcmcaccept_msc                     =   "float32",
        mcmcdrift_msc                      =   "float32",
        mg_gspphot                         =   "float32",
        mg_gspphot_lower                   =   "float32",
        mg_gspphot_upper                   =   "float32",
        mgfe_gspspec                       =   "float32",
        mgfe_gspspec_linescatter           =   "float32",
        mgfe_gspspec_lower                 =   "float32",
        mgfe_gspspec_nlines                =   "int32",
        mgfe_gspspec_upper                 =   "float32",
        mh_gspphot                         =   "float32",
        mh_gspphot_lower                   =   "float32",
        mh_gspphot_upper                   =   "float32",
        mh_gspspec                         =   "float32",
        mh_gspspec_lower                   =   "float32",
        mh_gspspec_upper                   =   "float32",
        mh_msc                             =   "float32",
        mh_msc_lower                       =   "float32",
        mh_msc_upper                       =   "float32",
        ndfe_gspspec                       =   "float32",
        ndfe_gspspec_linescatter           =   "float32",
        ndfe_gspspec_lower                 =   "float32",
        ndfe_gspspec_nlines                =   "int32",
        ndfe_gspspec_upper                 =   "float32",
        neuron_oa_dist                     =   "float32",
        neuron_oa_dist_percentile_rank     =   "int32",
        neuron_oa_id                       =   "int64",
        nfe_gspspec                        =   "float32",
        nfe_gspspec_linescatter            =   "float32",
        nfe_gspspec_lower                  =   "float32",
        nfe_gspspec_nlines                 =   "int32",
        nfe_gspspec_upper                  =   "float32",
        nife_gspspec                       =   "float32",
        nife_gspspec_linescatter           =   "float32",
        nife_gspspec_lower                 =   "float32",
        nife_gspspec_nlines                =   "int32",
        nife_gspspec_upper                 =   "float32",
        ra                                 =   "float64",
        radius_flame                       =   "float32",
        radius_flame_lower                 =   "float32",
        radius_flame_upper                 =   "float32",
        radius_gspphot                     =   "float32",
        radius_gspphot_lower               =   "float32",
        radius_gspphot_upper               =   "float32",
        sfe_gspspec                        =   "float32",
        sfe_gspspec_linescatter            =   "float32",
        sfe_gspspec_lower                  =   "float32",
        sfe_gspspec_nlines                 =   "int32",
        sfe_gspspec_upper                  =   "float32",
        sife_gspspec                       =   "float32",
        sife_gspspec_linescatter           =   "float32",
        sife_gspspec_lower                 =   "float32",
        sife_gspspec_nlines                =   "int32",
        sife_gspspec_upper                 =   "float32",
        solution_id                        =   "int64",
        source_id                          =   "int64",
        spectraltype_esphs                 =   "int8",
        teff_esphs                         =   "float32",
        teff_esphs_uncertainty             =   "float32",
        teff_espucd                        =   "float32",
        teff_espucd_uncertainty            =   "float32",
        teff_gspphot                       =   "float32",
        teff_gspphot_lower                 =   "float32",
        teff_gspphot_upper                 =   "float32",
        teff_gspspec                       =   "float32",
        teff_gspspec_lower                 =   "float32",
        teff_gspspec_upper                 =   "float32",
        teff_msc1                          =   "float32",
        teff_msc1_lower                    =   "float32",
        teff_msc1_upper                    =   "float32",
        teff_msc2                          =   "float32",
        teff_msc2_lower                    =   "float32",
        teff_msc2_upper                    =   "float32",
        tife_gspspec                       =   "float32",
        tife_gspspec_linescatter           =   "float32",
        tife_gspspec_lower                 =   "float32",
        tife_gspspec_nlines                =   "int32",
        tife_gspspec_upper                 =   "float32",
        vsini_esphs                        =   "float32",
        vsini_esphs_uncertainty            =   "float32",
        zrfe_gspspec                       =   "float32",
        zrfe_gspspec_linescatter           =   "float32",
        zrfe_gspspec_lower                 =   "float32",
        zrfe_gspspec_nlines                =   "int32",
        zrfe_gspspec_upper                 =   "float32",
    ),
)

def parquet_to_hdf5(dir, dset_name, cleanup):
    parquet_files = glob.glob(f"{dir}/*.parquet")
    tables = [pq.read_table(parquet_file, memory_map=True) for parquet_file in parquet_files]
    table = pa.concat_tables(tables)
    with h5py.File(f"{dir}/001-of-001.hdf5", "w") as f:
        for col in table.column_names:
            f.create_dataset(col, data=np.stack(np.asarray(table[col])), dtype=DTYPES[dset_name][col])
    if cleanup:
        for pqf in parquet_files:
            os.remove(pqf)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Convert parquet files to hdf5")
    parser.add_argument("--input_dir", type=str, help="directory to parquet files")
    parser.add_argument("--num_workers", type=int, help="number of workers to use", default=os.cpu_count())
    parser.add_argument("--cleanup", action="store_true", help="delete parquet files after conversion", default=False)
    args = parser.parse_args()

    healpix_dirs = dict(
        SOURCE=glob.glob(f"{args.input_dir}/dr3_source/*"),
        XP=glob.glob(f"{args.input_dir}/dr3_xp/*"),
        RVS=glob.glob(f"{args.input_dir}/dr3_rvs/*"),
        AP=glob.glob(f"{args.input_dir}/dr3_ap/*"),
    )

    for dset_name, dir in healpix_dirs.items():
        process_map(partial(parquet_to_hdf5, dset_name=dset_name, cleanup=args.cleanup), dir, max_workers=args.num_workers, chunksize=1, desc=f"Converting {dset_name} to hdf5")

